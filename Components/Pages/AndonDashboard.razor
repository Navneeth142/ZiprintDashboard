@page "/dashboard"
@using BlazorAssignment.Services
@using BlazorAssignment.Helper
@inject AndonRealtimeService Service
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<PageTitle>Andon Dashboard</PageTitle>

<!-- TOP GREEN HEADER -->
<AndonHeader Date="state.DateTime" />

<!-- FULL GREEN PAGE -->
<div class="andon-page">

    <!-- WHITE DASHBOARD CARD -->
    <div class="andon-container">

        <!-- LEFT : PART STATUS TABLE -->
        <PartStatusTable
            Parts="state.Parts"
            SelectedParts="selectedParts"
            OnPartToggled="OnPartToggled" />

        <!-- RIGHT : ALWAYS 3 BAR CHARTS -->
        <div class="charts">

            @for (int i = 0; i < 3; i++)
            {
                string? partNo = i < selectedParts.Count
                ? selectedParts[i]
                : null;

                <ShiftChartJs @key="i"
                              PartNo="@partNo"
                              CanvasId="@($"chart-{i}")"
                              Labels="@GetShiftLabels(partNo)"
                              Values="@GetShiftValues(partNo)" />
            }

        </div>

        <!-- KPI ROW -->
        <div class="kpi-container">
            <KpiFooter />
        </div>

        <!-- FOOTER LOGOS -->
        <div class="dashboard-footer">
            <img src="/images/Amit_image.png" class="logo-amit" />
            <img src="/images/AceMicromatic_image.png" class="logo-ace" />
        </div>

    </div>
</div>

@code {

    private BlazorAssignment.Models.AndonState state = new();

    // ✅ DEFAULT 3 SELECTED PARTS
    private List<string> selectedParts = new()
    {
        "B1223450",
        "C1223450",
        "D1223450"
    };

    protected override void OnInitialized()
    {
        state = Service.GetState();
    }

    // ✅ TOGGLE PART SELECTION (MAX 3)
    private void OnPartToggled(string partNo)
    {
        if (selectedParts.Contains(partNo))
        {
            selectedParts.Remove(partNo);
        }
        else if (selectedParts.Count < 3)
        {
            selectedParts.Add(partNo);
        }
    }

    // ✅ SAFE SHIFT LABELS (NEVER EMPTY)
    private string[] GetShiftLabels(string? partNo)
    {
        if (string.IsNullOrWhiteSpace(partNo))
            return new[] { "S-01", "S-02" };

        if (state.ShiftCounts.TryGetValue(partNo, out var values))
        {
            return Enumerable.Range(1, values.Length)
                             .Select(i => $"S-{i + 4}")
                             .ToArray();
        }

        return new[] { "S-01", "S-02" };
    }

    // ✅ SAFE SHIFT VALUES (ZERO WHEN NO DATA)
    private int[] GetShiftValues(string? partNo)
    {
        if (string.IsNullOrWhiteSpace(partNo))
            return new[] { 0, 0 };

        return state.ShiftCounts.TryGetValue(partNo, out var values)
            ? values
            : new[] { 0, 0 };
    }
}
